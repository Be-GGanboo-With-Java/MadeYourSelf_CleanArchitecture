# 계층형 아키텍처의 문제점

## 계층형 아키텍처 
1. 책에서 소개하는 전통적인 계층형 웹 어플리케이션 구조.
> 웹 -> 도메인 -> 영속성

2. 마틴파울러의 책 PoEAA 에서 소개하는 계층형 웹 어플리케이션 구조.
> Presentation -> Domain(Business) -> DataAcess
> 
> Presentation
> 1. 사용자와 상호작용 처리 계층.
> 2. HTTP 요청, HTTP 요청 처리, HTML 처리 등 담당.
> 3. 흔히 말하는 MVC (Model, View, Controller) 도 이 계층에 속한다.
> 
> Domain
> 1. 서비스/시스템의 핵심 로직.
> 2. 유효성 검사 및 계산을 포함하는 Business 논리 계층.
> 3. Presentation 받은 데이터를 유효성 검사.
> 4. 어떤 Data Access 를 선택할지 결정.
> 
> Data Access 계층
> 1. DAO 계층.
> 2. Database/Messaging Queue/외부 API 와의 통신 등 처리
> 
> ![](/images/계층형.png)

> **나눠볼 얘기들**
> 
> "외부 API 와의 통신 등 처리" 를 Data Access 레이어에서 하는 이유는 무엇일까?
> 
> DTO 를 전역적으로 사용 하는 것 같은데 이에 대한 남영이 생각은?
## 계층형 아키텍처를 설계할때, 주의 해야 할점
- 계층화의 핵심은 각 계층은 응집도가 높으면서, 다른 계층과는 낮은 결합도를 가지는데 있다.
- 이를 위해서는 기본적으로 상위 계층은 하위 계층을 사용할 수 있지만, 하위 계층은 본인의 상위 계층으로 누가 있는지 인식 못하도록 해야한다.

## 계층화 아키텍처의 장점
- 관심사의 분리 ->  한 계층의 변경이 다른 계층의 구성 요소에 영향을 미치지 않도록 한다.
- 모듈 교체의 용이성 -> 결합도가 낮아 다른 모듈 구현체로 쉽게 변경 할 수 있다.
- 좀 더 용이한 테스트 -> 테스트 할때, MockBean 으로 다 끌고 와서 기능정의 해주어야되는데 굉장히 귀찮음.

## 계층화 아키텍처의 단점 1. 데이터 베이스 주도 설계를 유도한다.
- 계층형 아키텍처는 웹 계층은 도메인에, 도메인 계층은 영속성 계층에 의존하기 때문에 자연스레 데이터베이스에 의존 하게 된다.
- 전통적인 계층형 아키텍처 에서는 데이터베이스 구조를 먼저 생각하고 그것을 토대로 도메인 로직 구현.

> 비즈니스 관점에서는 다른 무엇보다도 도메인 로직을 먼저 만들어야 한다.
> 
> **그래야만 우리가 로직을 제대로 이해했는지 확인 할 수 있다.**

- DB 중심적 아키텍처가 만들어지는 원인은 ORM 프레임워크를 사용하기 때문이다.
> ORM 프레임워크를 계층형 아키텍처와 결합하면 비즈니스 규칙을 영속성 관점과 섞고 싶어진다. 그러나 도메인 계층에서 데이터베이스 엔티티를 사용하는 것은 영속성 계층과의 강한 결합을 유발한다.

- **애플리케이션에서는 도메인 로직을 먼저 만들고 도메인 로직이 맞았다고 생각될때, 이를 기반으로 영속성 계층과 웹 계층을 만들어야 한다.**

> **나눠볼 얘기들**
> 비즈니스 관점에서는 다른 무엇보다도 도메인 로직을 먼저 만들어야 한다. 이거에 대해서 어떻게 생각하는지.
> 
> "ORM 프레임워크를 계층형 아키텍처와 결합하면 비즈니스 규칙을 영속성 관점과 섞고 싶어진다. 
> 그러나 도메인 계층에서 데이터베이스 엔티티를 사용하는 것은 영속성 계층과의 강한 결합을 유발한다." 
> 이거에 대해서 공감이 가는 사람? (p.4)

## 계층화 아키텍처의 단점 2. 지름길을 선택하기 쉬워진다.
- 계층형 아키텍처의 제약사항은 "상위계층에서 하위 계층의 컴포넌트만 접근 가능하다" 이다.
- 이렇다 보니, 상위 계층에 접근 하기 위해서 계층을 내려버리면 바로 접근이 되다보니, 오랜 시간 유지보수를 하다보면,
- 영속성 계층이 비대 해질 가능성이 높다.

## 계층화 아키텍처의 단점 3. 테스트 하기 어려워진다.
- 게층을 건너뛰는 현상에서 문제점을 겪게 된다. 
- 예를 들어 웹 계층에서 영속성 계층에 직접적으로 접근 할 경우 

1. 도메인 로직을 웹계층에서 구현 하게 된다. -> 계층형 아키텍처의 본질이 피폭된다.
2. 웹 계층 테스트에서 영속성 계층 까지 모킹 해서 테스트 진행 해야 한다. (복잡한 테스트)

## 계층화 아키텍처의 단점 4. 유스케이스를 숨긴다.
- 계층형 아키텍처는 도메인 서비스의 "너비" 에 관한 규제를 강제 하지 않는다.
- 서비스의 "너비" 가 넓어지면, 더 많은 영속성 계층에 의존성을 갖게 되고,
- 웹 레이어의 많은 컴포넌트가 이 서비스에 의존하게 된다.

> **나눠볼 얘기들**
> 이부분은 내 생각에는 추상화를 잘 하면 되지 않을까? 라는 생각이 있는데 ...

## 계층화 아키텍처의 단점 5. 동시 작업이 어려워진다.
- 특정 기능을 추가 한다고 생각 했을때, 계층형 아키텍처에서는 한명은 웹계층에 필요한 기능을 개발하고,
- 다른 한명은 도메인 계층에 필요한 기능을 개발 하고 이런 분담을 하지 못한다. 

> 모든 것이 영속성 계층 위에 만들어 지기 때문에, 영송석 계층을 먼저 개발하고, 그다음 도메인 그다음 웹계층을 구현 해야한다.
> 
> 그러다보니, 특정 기능을 동시에 한명의 개발자만 작업 할 수 있다.

## 결론
> 계층형 아키텍처의 함정을 염두에 두고 개발하자.



